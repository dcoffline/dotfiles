# â”€â”€â”€â”€â”€â”€ EXPORTS (all exported for bash compatibility) â”€â”€â”€â”€â”€â”€
export LANG=en_US.UTF-8 LC_CTYPE=$LANG LC_COLLATE=$LANG
export HISTFILE="$ZDOTDIR/.histfile" 
export HISTSIZE=10000 SAVEHIST=10000 HISTTIMEFORMAT="%F %T"

export XDG_DATA_HOME="$HOME/.local/share" 
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_STATE_HOME="$HOME/.local/state" 
export XDG_CACHE_HOME="$HOME/.cache"

export EDITOR=nvim
export PATH="$HOME/.local/bin:/var/lib/flatpak/exports/bin:$HOME/.cargo/bin:$PATH"

# linuxbrew
export PATH="/home/linuxbrew/.linuxbrew/bin:$PATH"

# â”€â”€â”€â”€â”€â”€ SHORTCUTS â”€â”€â”€â”€â”€â”€
export gdrive=/var/mnt/2T/Mounts/GDrive
export media=/var/mnt/2T/Mounts/Media
export t2=/var/mnt/2T
export t10=/var/mnt/10T

# â”€â”€â”€â”€â”€â”€ ALIASES â”€â”€â”€â”€â”€â”€
# Rclone Management
alias rmount='~/.config/rclone/rclone-mount.sh'
alias rremount='rumount; sleep 2; rmount'
alias rlsmount='mount | grep rclone || echo "No rclone mounts active"'

#File Management
#alias cat=bat 
alias cp='cp -i' 
alias mv='mv -i' 
alias rm='trash -v' 
alias mkdir='mkdir -p'
alias ..='cd ..' 
alias ...='cd ../..' 
alias ....='cd ../../..'
alias da='date "+%Y-%m-%d %A %T %Z"'
alias h='history | grep'
alias p='ps aux | grep'
alias yey=paru

# System Utilities
alias ff=fastfetch
alias j=jotta-cli
alias cid='echo $CONTAINER_ID'
alias linutil='curl -fsSL https://christitus.com/linux | sh'

# Distrobox
alias dea='distrobox enter arch'
alias dear='distrobox enter arch -e'
alias def='distrobox enter fedora'
alias defr='distrobox enter fedora -e'
alias dex='distrobox-export --app'
alias deb='distrobox-export --export-path ~/.local/bin --bin'
alias archup='distrobox enter arch -- sudo sh -c "rm -f /var/lib/pacman/db.lck && pacman -Syu --noconfirm"'

# Editor
alias ebrc='$EDITOR ~/.bashrc'
alias sbrc='source ~/.bashrc'
alias ezrc='$EDITOR ~/.zshrc'
alias szrc='source ~/.zshrc'
alias ecrc='$EDITOR ~/.commonrc'
alias scrc='source ~/.commonrc'
alias vi=$EDITOR
alias vim=$EDITOR
alias nano=$EDITOR
alias micro=$EDITOR
alias svi='sudo $EDITOR'
alias svim='sudo $EDITOR'
alias snano='sudo $EDITOR'

# Override OMZ defaults to use eza everywhere

# Aliases from bling.sh (eza and ugrep)
if [ "$(command -v eza)" ]; then
    alias ll='eza -l --icons=auto --group-directories-first'
    alias l.='eza -d .*'
    alias ls='eza --icons=auto --group-directories-first'
    alias l1='eza -1'
    alias l='eza -l'
    alias la='eza -la'
    alias lsa='eza -la'
fi

if [ "$(command -v ug)" ]; then
    alias grep='ug'
    alias egrep='ug -E'
    alias fgrep='ug -F'
    alias xzgrep='ug -z'
    alias xzegrep='ug -zE'
    alias xzfgrep='ug -zF'
fi

# â”€â”€â”€â”€â”€â”€ FUNCTIONS â”€â”€â”€â”€â”€â”€
# Yazi Shell Wrapper
y() {
  local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
  yazi "$@" --cwd-file="$tmp"
  local cwd="$(cat "$tmp")"
  [ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
  rm -f -- "$tmp"
}

# Nuke all rclone mounts (the nuclear one-liner we built)
rumount() {
  echo "ðŸ”ª Slaughtering all rclone mounts..."
  pkill -f "rclone mount" && echo "âœ… Processes terminated"
  rm -f ~/.config/rclone/pid/*.pid 2>/dev/null && echo "âœ… PID files vaporized"
  sleep 0.5
  fusermount -uz /var/mnt/2T/Mounts/* 2>/dev/null || true
  echo "ðŸ§¹ All mounts detached â€” 2T drive is now safe to yank"
  # You could even add a call to rlsmount here
  rlsmount
  sudo fuser -km /dev/sda1 2>/dev/null || true
}

# Give systemd access to arch container
sysd() {
  sudo mkdir -p /run/dbus;
  sudo ln -sf /run/host/container-manager/dbus/systemd/system /run/dbus/system;
  ln -sf /run/host/container-manager/dbus/systemd/user /run/user/$(id -u)/systemd
}

# Automatically do an ls after each cd, z, or zoxide
cd () {
  if [ -n "$1" ]; then
  	builtin cd "$@" && ls
  else
  	builtin cd ~ && ls
  fi
}

# IP address lookup
alias whatismyip="whatsmyip"
whatsmyip () {
  # Internal IP Lookup.
  if command -v ip &> /dev/null; then
    echo -n "Internal IP: "
      ip addr show wlan0 | grep "inet " | awk '{print $2}' | cut -d/ -f1
  else
    echo -n "Internal IP: "
    ifconfig wlan0 | grep "inet " | awk '{print $2}'
  fi

  # External IP Lookup
  echo -n "External IP: "
  curl -4 ifconfig.me
}

# Goes up a specified number of directories  (i.e. up 4)
up() {
  local d=""
  limit=$1
  for ((i = 1; i <= limit; i++)); do
  	d=$d/..
  done
  d=$(echo $d | sed 's/^\///')
  if [ -z "$d" ]; then
	d=..
  fi
  cd $d
}

# Copy file with a progress bar
cpp() {
  set -e
  strace -q -ewrite cp -- "${1}" "${2}" 2>&1 |
  awk '{
    count += $NF
      if (count % 10 == 0) {
        percent = count / total_size * 100
        printf "%3d%% [", percent
        for (i=0;i<=percent;i++)
          printf "="
        printf ">"
          for (i=percent;i<100;i++)
            printf " "
          printf "]\r"
      }
  }
  END { print "" }' total_size="$(stat -c '%s' "${1}")" count=0
}

# Copy and go to the directory
cpg() {
  if [ -d "$2" ]; then
	cp "$1" "$2" && cd "$2"
  else
	cp "$1" "$2"
  fi
}

# Move and go to the directory
mvg() {
  if [ -d "$2" ]; then
	mv "$1" "$2" && cd "$2"
  else
	mv "$1" "$2"
  fi
}

# Create and go to the directory
mkdirg() {
  mkdir -p "$1"
  cd "$1"
}

# Searches for text in all files in the current folder
ftext() {
  # -i case-insensitive
  # -I ignore binary files
  # -H causes filename to be printed
  # -r recursive search
  # -n causes line number to be printed
  # optional -F treat search term as a literal, not a regular expression
  # optional -l only print filenames and not the matching lines ex. grep -irl "$1" *
  grep -iIHrn --color=always "$1" . | less -r
}

# Extracts any archive(s) (if unp isn't installed)
extract() {
  for archive in "$@"; do
	if [ -f "$archive" ]; then
		case $archive in
		*.tar.bz2) tar xvjf $archive ;;
		*.tar.gz) tar xvzf $archive ;;
		*.bz2) bunzip2 $archive ;;
		*.rar) rar x $archive ;;
		*.gz) gunzip $archive ;;
		*.tar) tar xvf $archive ;;
		*.tbz2) tar xvjf $archive ;;
		*.tgz) tar xvzf $archive ;;
		*.zip) unzip $archive ;;
		*.Z) uncompress $archive ;;
		*.7z) 7z x $archive ;;
		*) echo "don't know how to extract '$archive'..." ;;
		esac
	else
		echo "'$archive' is not a valid file!"
	fi
  done
}
